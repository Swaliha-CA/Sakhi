<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micronutrient Tracking - Sakhi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .container {
            max-width: 1400px;
        }
        .module-header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        .nutrient-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .btn-back {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .btn-back:hover {
            color: white;
            transform: translateY(-2px);
        }
        .nutrient-level {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #8b5cf6;
        }
        .nutrient-level.deficient {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .nutrient-level.low {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .nutrient-level.normal {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .nutrient-level.high {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        .level-indicator {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .level-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .level-bar.deficient { background: #ef4444; }
        .level-bar.low { background: #f59e0b; }
        .level-bar.normal { background: #10b981; }
        .level-bar.high { background: #3b82f6; }
        .add-result-form {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .alert-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .recommendation-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .food-suggestion {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }
        .food-icon {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: #8b5cf6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </a>
        
        <div class="module-header">
            <div class="mb-4">
                <i class="fas fa-flask fa-4x text-primary"></i>
            </div>
            <h1>Micronutrient Tracking <span class="badge bg-success">INTERACTIVE</span></h1>
            <p class="lead">Track lab results, detect deficiencies, and monitor trends</p>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="nutrient-card">
                    <h3><i class="fas fa-chart-line text-primary"></i> Current Nutrient Levels</h3>
                    <div id="nutrientLevels">
                        <!-- Nutrient levels will be loaded here -->
                    </div>
                </div>

                <div class="add-result-form">
                    <h4><i class="fas fa-plus-circle text-success"></i> Add Lab Result</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Nutrient</label>
                            <select class="form-select" id="nutrientSelect">
                                <option value="hemoglobin">Hemoglobin</option>
                                <option value="vitamin_b12">Vitamin B12</option>
                                <option value="folate">Folate</option>
                                <option value="ferritin">Ferritin</option>
                                <option value="vitamin_d">Vitamin D</option>
                                <option value="iron">Iron</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Value</label>
                            <input type="number" class="form-control" id="valueInput" placeholder="Enter value" step="0.1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="dateInput">
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success" onclick="addLabResult()">
                            <i class="fas fa-plus"></i> Add Result
                        </button>
                        <button class="btn btn-outline-primary" onclick="generateSampleData()">
                            <i class="fas fa-magic"></i> Load Sample Data
                        </button>
                    </div>
                </div>

                <div class="chart-container">
                    <h4><i class="fas fa-chart-area text-info"></i> Trend Analysis</h4>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="nutrient-card">
                    <h4><i class="fas fa-exclamation-triangle text-warning"></i> Alerts</h4>
                    <div id="alertsContainer">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>

                <div class="nutrient-card">
                    <h4><i class="fas fa-lightbulb text-info"></i> Recommendations</h4>
                    <div id="recommendationsContainer">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>

                <div class="nutrient-card">
                    <h4><i class="fas fa-utensils text-success"></i> Food Suggestions</h4>
                    <div id="foodSuggestions">
                        <!-- Food suggestions will be loaded here -->
                    </div>
                </div>

                <div class="nutrient-card">
                    <h4><i class="fas fa-chart-pie text-primary"></i> Quick Stats</h4>
                    <div class="row text-center">
                        <div class="col-6">
                            <h3 class="text-danger" id="deficientCount">0</h3>
                            <small class="text-muted">Deficient</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success" id="normalCount">0</h3>
                            <small class="text-muted">Normal</small>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <h3 class="text-info" id="totalTests">0</h3>
                            <small class="text-muted">Total Tests</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-warning" id="lastUpdate">--</h3>
                            <small class="text-muted">Days Ago</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Nutrient reference ranges and data
        const nutrientRanges = {
            hemoglobin: { min: 12.0, max: 15.5, unit: 'g/dL', name: 'Hemoglobin' },
            vitamin_b12: { min: 200, max: 900, unit: 'pg/mL', name: 'Vitamin B12' },
            folate: { min: 2.7, max: 17.0, unit: 'ng/mL', name: 'Folate' },
            ferritin: { min: 15, max: 150, unit: 'ng/mL', name: 'Ferritin' },
            vitamin_d: { min: 30, max: 100, unit: 'ng/mL', name: 'Vitamin D' },
            iron: { min: 60, max: 170, unit: 'Œºg/dL', name: 'Iron' }
        };

        let nutrientData = {
            hemoglobin: [],
            vitamin_b12: [],
            folate: [],
            ferritin: [],
            vitamin_d: [],
            iron: []
        };

        let trendChart = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            generateSampleData();
        });

        function generateSampleData() {
            // Generate sample data for the last 6 months
            const today = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            
            nutrientData = {
                hemoglobin: [
                    { date: '2024-01-15', value: 10.5 },
                    { date: '2024-03-20', value: 11.2 },
                    { date: '2024-05-10', value: 12.8 }
                ],
                vitamin_b12: [
                    { date: '2024-02-01', value: 180 },
                    { date: '2024-04-15', value: 220 },
                    { date: '2024-06-01', value: 350 }
                ],
                folate: [
                    { date: '2024-01-20', value: 2.1 },
                    { date: '2024-04-10', value: 3.5 }
                ],
                ferritin: [
                    { date: '2024-02-15', value: 8 },
                    { date: '2024-05-20', value: 25 }
                ],
                vitamin_d: [
                    { date: '2024-03-01', value: 18 },
                    { date: '2024-06-15', value: 32 }
                ],
                iron: [
                    { date: '2024-01-10', value: 45 },
                    { date: '2024-04-20', value: 75 }
                ]
            };

            updateDisplay();
        }

        function addLabResult() {
            const nutrient = document.getElementById('nutrientSelect').value;
            const value = parseFloat(document.getElementById('valueInput').value);
            const date = document.getElementById('dateInput').value;

            if (!value || !date) {
                alert('Please enter both value and date');
                return;
            }

            nutrientData[nutrient].push({ date, value });
            nutrientData[nutrient].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Clear form
            document.getElementById('valueInput').value = '';
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

            updateDisplay();
            
            // Show success message
            alert(`‚úÖ Lab result added successfully!\n\n${nutrientRanges[nutrient].name}: ${value} ${nutrientRanges[nutrient].unit}\nDate: ${date}`);
        }

        function updateDisplay() {
            displayNutrientLevels();
            displayAlerts();
            displayRecommendations();
            displayFoodSuggestions();
            updateStats();
            updateTrendChart();
        }

        function displayNutrientLevels() {
            const container = document.getElementById('nutrientLevels');
            
            container.innerHTML = Object.keys(nutrientRanges).map(nutrient => {
                const range = nutrientRanges[nutrient];
                const data = nutrientData[nutrient];
                const latestValue = data.length > 0 ? data[data.length - 1].value : null;
                const status = getStatus(latestValue, range);
                const percentage = getPercentage(latestValue, range);

                return `
                    <div class="nutrient-level ${status}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">${range.name}</h5>
                            <span class="badge bg-${getStatusColor(status)}">${status.toUpperCase()}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>${latestValue ? latestValue + ' ' + range.unit : 'No data'}</span>
                            <span class="text-muted">Range: ${range.min}-${range.max} ${range.unit}</span>
                        </div>
                        <div class="level-indicator">
                            <div class="level-bar ${status}" style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">
                            ${data.length > 0 ? `Last updated: ${data[data.length - 1].date}` : 'No tests recorded'}
                        </small>
                    </div>
                `;
            }).join('');
        }

        function getStatus(value, range) {
            if (!value) return 'unknown';
            if (value < range.min * 0.7) return 'deficient';
            if (value < range.min) return 'low';
            if (value <= range.max) return 'normal';
            return 'high';
        }

        function getStatusColor(status) {
            switch(status) {
                case 'deficient': return 'danger';
                case 'low': return 'warning';
                case 'normal': return 'success';
                case 'high': return 'info';
                default: return 'secondary';
            }
        }

        function getPercentage(value, range) {
            if (!value) return 0;
            const max = range.max * 1.2; // Extend range for visualization
            return Math.min((value / max) * 100, 100);
        }

        function displayAlerts() {
            const container = document.getElementById('alertsContainer');
            const alerts = [];

            Object.keys(nutrientRanges).forEach(nutrient => {
                const range = nutrientRanges[nutrient];
                const data = nutrientData[nutrient];
                if (data.length > 0) {
                    const latestValue = data[data.length - 1].value;
                    const status = getStatus(latestValue, range);
                    
                    if (status === 'deficient' || status === 'low') {
                        alerts.push({
                            nutrient: range.name,
                            status,
                            value: latestValue,
                            unit: range.unit,
                            severity: status === 'deficient' ? 'danger' : 'warning'
                        });
                    }
                }
            });

            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert alert-success">No deficiencies detected! Keep up the good work.</div>';
            } else {
                container.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.severity} alert-card">
                        <strong><i class="fas fa-exclamation-triangle"></i> ${alert.nutrient} ${alert.status.toUpperCase()}</strong><br>
                        Current: ${alert.value} ${alert.unit}<br>
                        <small>Requires immediate attention</small>
                    </div>
                `).join('');
            }
        }

        function displayRecommendations() {
            const container = document.getElementById('recommendationsContainer');
            const recommendations = [];

            // Check for deficiencies and generate recommendations
            Object.keys(nutrientRanges).forEach(nutrient => {
                const range = nutrientRanges[nutrient];
                const data = nutrientData[nutrient];
                if (data.length > 0) {
                    const latestValue = data[data.length - 1].value;
                    const status = getStatus(latestValue, range);
                    
                    if (status === 'deficient' || status === 'low') {
                        recommendations.push(getRecommendation(nutrient, status));
                    }
                }
            });

            if (recommendations.length === 0) {
                container.innerHTML = '<div class="recommendation-card"><i class="fas fa-check-circle text-success"></i> All nutrient levels are within normal ranges. Continue your current diet and lifestyle.</div>';
            } else {
                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-card">
                        <strong><i class="fas fa-lightbulb text-warning"></i> ${rec.title}</strong><br>
                        <small>${rec.description}</small>
                    </div>
                `).join('');
            }
        }

        function getRecommendation(nutrient, status) {
            const recommendations = {
                hemoglobin: {
                    title: 'Iron-Rich Foods Needed',
                    description: 'Include spinach, lentils, red meat, and iron supplements. Avoid tea/coffee with meals.'
                },
                vitamin_b12: {
                    title: 'B12 Supplementation Required',
                    description: 'Consider B12 injections or high-dose supplements. Include eggs, dairy, and fortified foods.'
                },
                folate: {
                    title: 'Folate Deficiency Alert',
                    description: 'Increase leafy greens, legumes, and fortified cereals. Consider folic acid supplements.'
                },
                ferritin: {
                    title: 'Iron Stores Low',
                    description: 'Iron supplements recommended. Include vitamin C to enhance absorption.'
                },
                vitamin_d: {
                    title: 'Vitamin D Deficiency',
                    description: 'Increase sun exposure, consider D3 supplements, include fatty fish in diet.'
                },
                iron: {
                    title: 'Iron Deficiency',
                    description: 'Iron-rich foods and supplements needed. Monitor for improvement in 3 months.'
                }
            };

            return recommendations[nutrient] || { title: 'Consult Healthcare Provider', description: 'Please discuss these results with your doctor.' };
        }

        function displayFoodSuggestions() {
            const container = document.getElementById('foodSuggestions');
            
            // Get deficient nutrients
            const deficientNutrients = [];
            Object.keys(nutrientRanges).forEach(nutrient => {
                const data = nutrientData[nutrient];
                if (data.length > 0) {
                    const latestValue = data[data.length - 1].value;
                    const status = getStatus(latestValue, nutrientRanges[nutrient]);
                    if (status === 'deficient' || status === 'low') {
                        deficientNutrients.push(nutrient);
                    }
                }
            });

            const foodSuggestions = {
                hemoglobin: { icon: 'ü•¨', name: 'Spinach & Lentils', description: 'Rich in iron and folate' },
                vitamin_b12: { icon: 'ü•ö', name: 'Eggs & Dairy', description: 'Natural B12 sources' },
                folate: { icon: 'ü•ó', name: 'Leafy Greens', description: 'High folate content' },
                ferritin: { icon: 'ü•©', name: 'Red Meat', description: 'Heme iron for better absorption' },
                vitamin_d: { icon: 'üêü', name: 'Fatty Fish', description: 'Salmon, mackerel, sardines' },
                iron: { icon: 'ü´ò', name: 'Beans & Legumes', description: 'Plant-based iron sources' }
            };

            if (deficientNutrients.length === 0) {
                container.innerHTML = '<div class="food-suggestion"><div class="food-icon">‚úÖ</div><div><strong>Balanced Diet</strong><br><small>Continue your current healthy eating habits</small></div></div>';
            } else {
                container.innerHTML = deficientNutrients.map(nutrient => {
                    const food = foodSuggestions[nutrient];
                    return `
                        <div class="food-suggestion">
                            <div class="food-icon">${food.icon}</div>
                            <div>
                                <strong>${food.name}</strong><br>
                                <small class="text-muted">${food.description}</small>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateStats() {
            let deficientCount = 0;
            let normalCount = 0;
            let totalTests = 0;
            let lastUpdateDays = 0;

            Object.keys(nutrientRanges).forEach(nutrient => {
                const data = nutrientData[nutrient];
                totalTests += data.length;
                
                if (data.length > 0) {
                    const latestValue = data[data.length - 1].value;
                    const status = getStatus(latestValue, nutrientRanges[nutrient]);
                    
                    if (status === 'deficient' || status === 'low') {
                        deficientCount++;
                    } else if (status === 'normal') {
                        normalCount++;
                    }

                    // Calculate days since last update
                    const lastDate = new Date(data[data.length - 1].date);
                    const today = new Date();
                    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    lastUpdateDays = Math.max(lastUpdateDays, daysDiff);
                }
            });

            document.getElementById('deficientCount').textContent = deficientCount;
            document.getElementById('normalCount').textContent = normalCount;
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('lastUpdate').textContent = lastUpdateDays;
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            // Prepare data for chart (showing hemoglobin trend as example)
            const hemoglobinData = nutrientData.hemoglobin;
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hemoglobinData.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Hemoglobin (g/dL)',
                        data: hemoglobinData.map(d => d.value),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Normal Range Min',
                        data: hemoglobinData.map(() => 12.0),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }, {
                        label: 'Normal Range Max',
                        data: hemoglobinData.map(() => 15.5),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Hemoglobin Trend Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 8,
                            max: 18
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>